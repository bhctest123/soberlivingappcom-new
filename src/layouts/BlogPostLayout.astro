---
import BaseLayout from './BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { data, slug } = post;
const { Content } = await post.render();

// Get all blog posts for navigation
const allPosts = await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
  return data.draft !== true;
});

// Sort posts by date (oldest to newest)
const sortedPosts = allPosts.sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => {
  return a.data.date.getTime() - b.data.date.getTime();
});

// Find current post index
const currentIndex = sortedPosts.findIndex((p: CollectionEntry<'blog'>) => p.slug === slug);

// Get previous and next posts
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

// Helper function to generate post URL
const getPostUrl = (post: CollectionEntry<'blog'>) => {
  const date = post.data.date;
  const year = date.getUTCFullYear();
  const month = date.getUTCMonth() + 1;
  const day = date.getUTCDate();
  return `/sober-living-app-blog/${year}/${month}/${day}/${post.slug}`;
};

// Generate the live site URL for QA - use UTC to match build process
const date = data.date;
const year = date.getUTCFullYear();
const month = date.getUTCMonth() + 1;
const day = date.getUTCDate();
const liveUrl = `https://soberlivingapp.com/sober-living-app-blog/${year}/${month}/${day}/${slug}`;

// Generate structured data for the blog post
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": data.title,
  "description": data.description,
  "author": {
    "@type": "Person",
    "name": data.author
  },
  "datePublished": date.toISOString(),
  "dateModified": date.toISOString(),
  "publisher": {
    "@type": "Organization",
    "name": "Sober Living App",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/brand/sober-living-app-text@2x.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `${Astro.site}blog/${slug}`
  },
  ...(data.image && {
    "image": {
      "@type": "ImageObject",
      "url": data.image,
      "alt": data.imageAlt || data.title
    }
  }),
  "keywords": data.tags?.join(', ') || '',
  "articleSection": data.category.join(', ')
};

// Calculate reading time (rough estimate: 200 words per minute)
const content = await post.body;
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// SEO metadata with fallbacks
const seoTitle = data.seo?.title || data.title;
const seoDescription = data.seo?.description || data.description;
const ogImage = data.seo?.ogImage || data.image || '/images/blog-default-og.jpg';
const canonicalUrl = data.seo?.canonicalUrl || `${Astro.site}blog/${slug}`;

// Format date for display - use UTC to match URL
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  timeZone: 'UTC'
});
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  image={ogImage}
  canonical={canonicalUrl}
  ogType="article"
  noindex={data.seo?.noindex || data.draft}
  structuredData={structuredData}
>
  <article class="min-h-screen bg-background">
    <div class="container mx-auto px-4 py-16">
      <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm text-muted-foreground">
            <li><a href="/" class="hover:text-foreground transition-colors">Home</a></li>
            <li class="text-muted-foreground/50">/</li>
            <li><a href="/blog" class="hover:text-foreground transition-colors">Blog</a></li>
            <li class="text-muted-foreground/50">/</li>
            <li class="text-foreground font-medium">{data.title}</li>
          </ol>
        </nav>

        <!-- Article Header -->
        <header class="mb-12">
          <div class="mb-6">
            <!-- Categories -->
            <div class="flex flex-wrap gap-2 mb-4">
              {data.category.map((cat: string) => (
                <span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full">
                  {cat}
                </span>
              ))}
            </div>

            <!-- Title -->
            <h1 class="text-4xl md:text-5xl font-bold mb-4 leading-tight">
              {data.title}
            </h1>

            <!-- Description -->
            <p class="text-xl text-muted-foreground mb-6">
              {data.description}
            </p>

            <!-- Meta information -->
            <div class="flex flex-wrap items-center gap-6 text-sm text-muted-foreground">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span>By {data.author}</span>
              </div>
              
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <time datetime={date.toISOString()}>{formattedDate}</time>
              </div>

              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>{data.readingTime || readingTime} min read</span>
              </div>
            </div>
          </div>

          <!-- Featured Image -->
          {data.image && (
            <div class="mb-8">
              <img 
                src={data.image}
                alt={data.imageAlt || data.title}
                class="w-full h-96 object-cover rounded-lg shadow-lg"
                loading="eager"
              />
            </div>
          )}

          <!-- Tags -->
          {data.tags && data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {data.tags.map((tag: string) => (
                <span class="inline-flex items-center px-2 py-1 text-sm bg-gray-100 text-gray-700 rounded-md">
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </header>

        <!-- QA Helper (only in development) -->
        {import.meta.env.DEV && (
          <div class="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="text-sm font-semibold text-yellow-800 mb-2">QA Helper (Development Only)</div>
            <div class="text-sm text-yellow-700">
              <div>Live URL: <a href={liveUrl} target="_blank" class="underline hover:text-yellow-900">{liveUrl}</a></div>
              <div>Current URL: {Astro.url.pathname}</div>
            </div>
          </div>
        )}

        <!-- Article Content -->
        <div class="blog-content">
          <Content />
        </div>

        <!-- Article Footer -->
        <footer class="mt-16 pt-8 border-t border-gray-200">
          <!-- Share buttons -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold mb-4">Share this article</h3>
            <div class="flex gap-4">
              <a
                href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(data.title)}&url=${encodeURIComponent(canonicalUrl)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-blue-400 text-white rounded-md hover:bg-blue-500 transition-colors"
              >
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
                Tweet
              </a>
              
              <a
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonicalUrl)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 transition-colors"
              >
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
                Share
              </a>
            </div>
          </div>

          <!-- Navigation to other posts -->
          <div class={`grid gap-4 mb-8 ${prevPost && nextPost ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>
            {prevPost && (
              <a 
                href={getPostUrl(prevPost)}
                class={`group flex items-center gap-4 p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all duration-200 border border-gray-200 hover:border-gray-300 ${!nextPost ? 'md:max-w-xl md:mx-auto' : ''}`}
              >
                <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-600 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <div class="text-left flex-1">
                  <div class="text-sm text-gray-500 mb-1">Previous Post</div>
                  <div class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-2">
                    {prevPost.data.title}
                  </div>
                </div>
              </a>
            )}
            
            {nextPost && (
              <a 
                href={getPostUrl(nextPost)}
                class={`group flex items-center gap-4 p-6 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all duration-200 border border-gray-200 hover:border-gray-300 md:flex-row-reverse md:text-right ${!prevPost ? 'md:max-w-xl md:mx-auto' : ''}`}
              >
                <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-600 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <div class="flex-1">
                  <div class="text-sm text-gray-500 mb-1">Next Post</div>
                  <div class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-2">
                    {nextPost.data.title}
                  </div>
                </div>
              </a>
            )}
          </div>
          
          <!-- Back to Blog -->
          <div class="text-center">
            <a 
              href="/blog" 
              class="inline-flex items-center px-4 py-2 text-gray-600 hover:text-gray-900 transition-colors font-medium"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              View All Blog Posts
            </a>
          </div>
        </footer>
      </div>
    </div>
  </article>
</BaseLayout>

<style is:global>
  /* Enhanced blog content styling for beautiful typography */
  .blog-content {
    font-size: 1.125rem;
    line-height: 1.75;
    color: #374151;
    max-width: 100%;
  }

  /* Headings with beautiful typography */
  .blog-content h1,
  .blog-content h2,
  .blog-content h3,
  .blog-content h4,
  .blog-content h5,
  .blog-content h6 {
    color: #111827;
    font-weight: 700;
    line-height: 1.2;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    letter-spacing: -0.025em;
  }

  .blog-content h1 {
    font-size: 2.5rem;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    border-bottom: 3px solid #3b82f6;
    padding-bottom: 0.5rem;
  }

  .blog-content h2 {
    font-size: 2rem;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    color: #1f2937;
    position: relative;
  }

  .blog-content h2::before {
    content: '';
    position: absolute;
    left: -1rem;
    top: 0.5rem;
    width: 4px;
    height: 1.5rem;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 2px;
  }

  .blog-content h3 {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #374151;
  }

  .blog-content h4 {
    font-size: 1.25rem;
    margin-top: 1.75rem;
    margin-bottom: 0.75rem;
    color: #4b5563;
  }

  /* Paragraphs with improved readability */
  .blog-content p {
    margin-bottom: 1.5rem;
    text-align: left;
  }

  /* Lists with custom styling */
  .blog-content ul,
  .blog-content ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .blog-content ul {
    list-style-type: none;
  }

  .blog-content ul li {
    position: relative;
    margin-bottom: 0.75rem;
    padding-left: 1.5rem;
  }

  .blog-content ul li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: bold;
    font-size: 1.2em;
  }

  .blog-content ol {
    list-style-type: decimal;
  }

  .blog-content ol li {
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
  }

  /* Links with beautiful styling */
  .blog-content a {
    color: #2563eb;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .blog-content a:hover {
    color: #1d4ed8;
    border-bottom-color: #1d4ed8;
  }

  /* Blockquotes with elegant styling */
  .blog-content blockquote {
    margin: 2rem 0;
    padding: 1.5rem 2rem;
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border-left: 4px solid #3b82f6;
    border-radius: 0.5rem;
    font-style: italic;
    color: #1e40af;
    position: relative;
  }

  .blog-content blockquote::before {
    content: '"';
    position: absolute;
    top: -0.5rem;
    left: 1rem;
    font-size: 3rem;
    color: #3b82f6;
    opacity: 0.3;
  }

  /* Code blocks and inline code */
  .blog-content code {
    background-color: #f3f4f6;
    color: #dc2626;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  }

  .blog-content pre {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 2rem 0;
    border: 1px solid #374151;
  }

  .blog-content pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
  }

  /* Images with beautiful styling */
  .blog-content img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    margin: 2rem 0;
  }

  /* Tables with professional styling */
  .blog-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .blog-content th {
    background-color: #3b82f6;
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
  }

  .blog-content td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .blog-content tr:nth-child(even) {
    background-color: #f9fafb;
  }

  /* Horizontal rules */
  .blog-content hr {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, #3b82f6, transparent);
    margin: 3rem 0;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .blog-content {
      font-size: 1rem;
    }
    
    .blog-content h1 {
      font-size: 2rem;
    }
    
    .blog-content h2 {
      font-size: 1.75rem;
    }
    
    .blog-content h3 {
      font-size: 1.375rem;
    }
  }

  /* Print styles */
  @media print {
    .blog-content {
      font-size: 12pt;
      line-height: 1.6;
    }
  }
</style>